<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SID Lite ‚Äì Form Pendataan Warga</title>
  <style>
    :root{
      --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-secondary: #f0f4f8;
      --card: #ffffff;
      --text: #1a202c;
      --text-light: #4a5568;
      --muted: #718096;
      --line: #e2e8f0;
      --accent: #3182ce;
      --accent-dark: #2c5282;
      --accent-soft: #ebf8ff;
      --ok: #38a169;
      --ok-soft: #f0fff4;
      --warn: #dd6b20;
      --warn-soft: #fffaf0;
      --danger: #e53e3e;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
      --radius: 12px;
      --radius-lg: 16px;
    }

    *{
      box-sizing:border-box;
      margin: 0;
      padding: 0;
    }

    html{
      scroll-behavior: smooth;
    }

    body{
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif;
      background: var(--bg-secondary);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Header Bar with Government Branding */
    .gov-header{
      background: var(--bg);
      padding: 16px 0;
      box-shadow: var(--shadow-md);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .gov-header-content{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .gov-logo{
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
      font-weight: 700;
      font-size: 18px;
    }

    .gov-logo-icon{
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .gov-title{
      flex: 1;
      min-width: 200px;
    }

    .gov-title h1{
      font-size: 20px;
      margin: 0;
      color: white;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .gov-title p{
      font-size: 12px;
      color: rgba(255,255,255,0.9);
      margin: 0;
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 20px;
    }

    /* HEADER (sticky) */
    .header{
      background: var(--card);
      border: none;
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-lg);
      position: sticky;
      top: 90px;
      z-index: 50;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-bottom: 24px;
    }

    .header.compact{
      padding: 16px 20px;
      box-shadow: var(--shadow-md);
    }

    .row{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      align-items: end;
    }

    .col{
      display: flex;
      flex-direction: column;
    }

    label{
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin: 0 0 8px;
      letter-spacing: 0.01em;
    }

    input, select, button{
      width: 100%;
      border: 2px solid var(--line);
      background: #fff;
      color: var(--text);
      padding: 12px 16px;
      border-radius: var(--radius);
      outline: none;
      font-size: 14px;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    input:focus, select:focus{
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    input::placeholder{
      color: var(--muted);
    }

    button{
      cursor: pointer;
      background: var(--accent);
      color: #fff;
      border: 2px solid var(--accent);
      font-weight: 700;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    button:hover{
      background: var(--accent-dark);
      border-color: var(--accent-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    button:active{
      transform: translateY(0);
    }

    button.secondary{
      background: #fff;
      color: var(--text);
      border: 2px solid var(--line);
      font-weight: 700;
    }

    button.secondary:hover{
      background: var(--bg-secondary);
      border-color: var(--muted);
      transform: translateY(-1px);
    }

    .pill{
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      border: 2px solid var(--line);
      background: #fff;
      color: var(--text-light);
      white-space: nowrap;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .pill strong{
      color: var(--text);
      font-weight: 700;
    }

    .pill:hover{
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    /* SEARCH AREA */
    .searchArea{
      margin-top: 16px;
    }

    .results{
      margin-top: 20px;
      border: 2px solid var(--accent);
      border-radius: var(--radius-lg);
      padding: 20px;
      background: var(--accent-soft);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn{
      from{
        opacity: 0;
        transform: translateY(-10px);
      }
      to{
        opacity: 1;
        transform: translateY(0);
      }
    }

    .results-top{
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }

    .results-actions{
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .reslist{
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .reslist::-webkit-scrollbar{
      width: 8px;
    }

    .reslist::-webkit-scrollbar-track{
      background: var(--line);
      border-radius: 999px;
    }

    .reslist::-webkit-scrollbar-thumb{
      background: var(--accent);
      border-radius: 999px;
    }

    .resitem{
      text-align: left;
      background: #fff;
      border: 2px solid transparent;
      border-radius: var(--radius);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .resitem:hover{
      border-color: var(--accent);
      box-shadow: var(--shadow-md);
      transform: translateX(4px);
    }

    .resitem .name{
      font-weight: 700;
      font-size: 16px;
      color: var(--text);
      margin-bottom: 8px;
    }

    .resitem .meta{
      font-size: 13px;
      color: var(--muted);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* COMPACT BAR (shown when selected) */
    .compactBar{
      display: none;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }

    .header.compact .compactBar{
      display: flex;
    }

    .header.compact .searchArea{
      display: none;
    }

    .compactLeft{
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .compactRight{
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .compactTitle{
      font-weight: 700;
      color: var(--text);
      font-size: 14px;
      margin-right: 4px;
    }

    /* MAIN CARD */
    .card{
      background: var(--card);
      border: none;
      border-radius: var(--radius-lg);
      padding: 28px;
      box-shadow: var(--shadow-lg);
      margin-bottom: 24px;
    }

    .section-title{
      display: flex;
      gap: 16px;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .section-title h2{
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }

    .section-title p{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    .tabs{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      border-bottom: 2px solid var(--line);
      padding-bottom: 16px;
      margin-bottom: 24px;
    }

    .tab{
      padding: 12px 20px;
      border-radius: var(--radius);
      border: 2px solid transparent;
      background: var(--bg-secondary);
      color: var(--text-light);
      cursor: pointer;
      user-select: none;
      font-weight: 700;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .tab:hover{
      background: var(--accent-soft);
      color: var(--accent);
    }

    .tab.active{
      color: #fff;
      border-color: var(--accent);
      background: var(--accent);
      box-shadow: var(--shadow-md);
    }

    .tabpanel{
      display: none;
    }

    .tabpanel.active{
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn{
      from{
        opacity: 0;
      }
      to{
        opacity: 1;
      }
    }

    .kpi{
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .badge{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 14px;
      border: 2px solid;
      font-weight: 700;
      white-space: nowrap;
      transition: all 0.2s ease;
    }

    .badge.ok{
      border-color: var(--ok);
      background: var(--ok-soft);
      color: var(--ok);
    }

    .badge.warn{
      border-color: var(--warn);
      background: var(--warn-soft);
      color: var(--warn);
    }

    .q-list{
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .q-item{
      border: 2px solid var(--line);
      border-radius: var(--radius);
      padding: 20px;
      background: #fff;
      transition: all 0.2s ease;
    }

    .q-item:hover{
      border-color: var(--accent);
      box-shadow: var(--shadow-sm);
    }

    .q-item label{
      margin: 0 0 10px;
      font-size: 14px;
      color: var(--text);
      font-weight: 600;
      display: block;
      line-height: 1.5;
    }

    .q-item select{
      cursor: pointer;
    }

    .footer-actions{
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 2px solid var(--line);
    }

    .mini{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      font-style: italic;
    }

    details{
      padding: 12px;
      border: 2px solid var(--line);
      border-radius: var(--radius);
      background: var(--bg-secondary);
      transition: all 0.2s ease;
    }

    details[open]{
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    details summary{
      outline: none;
      transition: color 0.2s ease;
    }

    details summary:hover{
      color: var(--accent-dark);
    }

    /* RESPONSIVE DESIGN */
    @media (max-width: 1024px){
      .gov-header{
        position: static;
      }

      .header{
        top: 12px;
      }

      .card{
        padding: 20px;
      }
    }

    @media (max-width: 768px){
      .gov-title h1{
        font-size: 16px;
      }

      .gov-logo-icon{
        width: 36px;
        height: 36px;
        font-size: 20px;
      }

      .header{
        position: static;
        top: 0;
        padding: 20px;
      }

      .header.compact{
        padding: 16px;
      }

      .row{
        grid-template-columns: 1fr;
      }

      .reslist{
        max-height: 400px;
      }

      .results-top{
        flex-direction: column;
        align-items: stretch;
      }

      .results-actions{
        flex-direction: column;
      }

      .compactBar{
        flex-direction: column;
        align-items: stretch;
      }

      .compactLeft, .compactRight{
        flex-direction: column;
        align-items: stretch;
      }

      .tabs{
        flex-direction: column;
        align-items: stretch;
      }

      .tab{
        text-align: center;
      }

      .section-title{
        flex-direction: column;
      }

      .card{
        padding: 16px;
      }

      .q-item{
        padding: 16px;
      }

      .footer-actions{
        flex-direction: column;
      }

      button{
        width: 100%;
      }
    }

    @media (max-width: 480px){
      .wrap{
        padding: 16px 12px;
      }

      .gov-header-content{
        padding: 0 12px;
      }

      .section-title h2{
        font-size: 18px;
      }

      .pill, .badge{
        font-size: 12px;
        padding: 6px 12px;
      }
    }
  </style>
</head>

<body>
  <!-- Government Header Bar -->
  <div class="gov-header">
    <div class="gov-header-content">
      <div class="gov-logo">
        <div class="gov-logo-icon">üèõÔ∏è</div>
      </div>
      <div class="gov-title">
        <h1>SID Lite ‚Äì Sistem Informasi Desa</h1>
        <p>Form Pendataan Sarana Prasarana Rumah Tinggal</p>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- HEADER -->
    <div class="header" id="headerBox">

      <!-- COMPACT MODE BAR -->
      <div class="compactBar">
        <div class="compactLeft">
          <span class="compactTitle">Warga Terpilih</span>
          <span class="pill"><strong id="cName">-</strong></span>
          <span class="pill">NIK: <strong id="cNik">-</strong></span>
          <span class="pill">Wilayah: <strong id="cArea">-</strong></span>
        </div>
        <div class="compactRight">
          <button id="btnChangeWarga" class="secondary" style="min-width:160px">üîÑ Ganti Warga</button>
        </div>
      </div>

      <!-- EXPANDED SEARCH AREA -->
      <div class="searchArea" id="searchArea">
        <div style="margin-bottom: 16px;">
          <label>Cari Warga (NIK atau Nama)</label>
          <div style="display: flex; gap: 12px; align-items: end; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 280px;">
              <input id="qText" type="text" placeholder="Ketik NIK atau nama warga... (contoh: 3173... atau Siti)" />
            </div>
            <button id="btnSearch" style="min-width: 140px;">üîç Cari</button>
          </div>
          <div class="mini">Pencarian otomatis mencari berdasarkan NIK dan nama secara bersamaan</div>
        </div>

        <!-- Filter Wilayah (Optional) -->
        <details style="margin-bottom: 12px;">
          <summary style="cursor: pointer; padding: 8px 0; font-weight: 600; color: var(--accent); user-select: none;">
            üìç Filter Wilayah (Opsional)
          </summary>
          <div class="row" style="margin-top: 12px;">
            <div class="col">
              <label>Dusun</label>
              <input id="qDusun" type="text" placeholder="Contoh: Dusun I" />
            </div>
            <div class="col">
              <label>RW</label>
              <input id="qRw" type="text" placeholder="Contoh: 02" />
            </div>
            <div class="col">
              <label>RT</label>
              <input id="qRt" type="text" placeholder="Contoh: 01" />
            </div>
          </div>
        </details>

        <div class="results" id="resultsBox">
          <div class="results-top">
            <div class="results-actions">
              <span class="pill">Hasil: <strong id="resCount">0</strong></span>
              <span class="pill">Warga Terpilih: <strong id="selectedName">-</strong></span>
              <span class="pill">NIK: <strong id="selectedNik">-</strong></span>
              <span class="pill">Wilayah: <strong id="selectedArea">-</strong></span>
            </div>
            <div class="results-actions">
              <button id="btnClear" class="secondary" style="min-width:160px">üîÑ Reset Filter</button>
            </div>
          </div>
          <div class="reslist" id="resList"></div>
        </div>
      </div>
    </div>

    <!-- MAIN FORM -->
    <div class="card" id="formCard">
      <div class="section-title">
        <div>
          <h2>SID Lite ‚Äì Verifikasi Sarana Prasarana Rumah Tinggal</h2>
          <p>Pilih tab di bawah untuk mengisi data verifikasi. Status verifikasi dihitung dari jumlah pertanyaan wajib yang sudah dipilih.</p>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Tabs">
        <div class="tab active" data-tab="jamban" role="tab" aria-selected="true">Jamban Septic</div>
        <div class="tab" data-tab="rtlh" role="tab" aria-selected="false">RTLH</div>
        <div class="tab" data-tab="pah" role="tab" aria-selected="false">PAH</div>
      </div>

      <!-- TAB: JAMBAN -->
      <div class="tabpanel active" id="tab-jamban" role="tabpanel">
        <div class="section-title">
          <div>
            <h2>Jamban Septic</h2>
            <p>Nilai: 0‚Äì4. Terverifikasi jika 4 (4 pertanyaan wajib terisi).</p>
          </div>
          <div class="kpi">
            <span class="pill">Nilai: <strong id="score-jamban">0</strong> / 4</span>
            <span class="badge warn" id="status-jamban">‚ö† Belum Terverifikasi</span>
          </div>
        </div>

        <div class="q-list">
          <div class="q-item">
            <label>b3r301a ‚Äî Status kepemilikan bangunan tempat tinggal yang ditempati</label>
            <select data-module="jamban" data-required="1" id="j_b3r301a">
              <option value="">‚Äî Pilih ‚Äî</option>
              <option value="1">1. Milik sendiri</option>
              <option value="2">2. Kontrak / Sewa</option>
              <option value="3">3. Bebas sewa</option>
              <option value="4">4. Dinas</option>
              <option value="5">5. Lainnya</option>
            </select>
          </div>

          <div class="q-item">
            <label>b3r309a ‚Äî Kepemilikan dan penggunaan fasilitas tempat buang air besar</label>
            <select data-module="jamban" data-required="1" id="j_b3r309a">
              <option value="">‚Äî Pilih ‚Äî</option>
              <option value="1">1. Ada, digunakan hanya anggota keluarga sendiri</option>
              <option value="2">2. Ada, digunakan bersama anggota keluarga dari keluarga tertentu</option>
              <option value="3">3. Ada, di MCK komunal</option>
              <option value="4">4. Ada, di MCK umum / siapapun menggunakan</option>
              <option value="5">5. Ada, anggota keluarga tidak menggunakan</option>
              <option value="6">6. Tidak ada fasilitas</option>
            </select>
          </div>

          <div class="q-item">
            <label>b3r309b ‚Äî Jenis kloset</label>
            <select data-module="jamban" data-required="1" id="j_b3r309b">
              <option value="">‚Äî Pilih ‚Äî</option>
              <option value="1">1. Kloset duduk leher angsa</option>
              <option value="2">2. Kloset jongkok leher angsa</option>
              <option value="3">3. Plengsengan dengan tutup</option>
              <option value="4">4. Plengsengan tanpa tutup</option>
              <option value="5">5. Cemplung / cubluk</option>
            </select>
          </div>

          <div class="q-item">
            <label>b3r310 ‚Äî Tempat pembuangan akhir tinja</label>
            <select data-module="jamban" data-required="1" id="j_b3r310">
              <option value="">‚Äî Pilih ‚Äî</option>
              <option value="1">1. Tangki septik</option>
              <option value="2">2. IPAL</option>
              <option value="3">3. Kolam / sawah / sungai / danau / laut</option>
              <option value="4">4. Lubang tanah</option>
              <option value="5">5. Pantai / tanah lapang / kebun</option>
              <option value="6">6. Lainnya</option>
            </select>
          </div>
        </div>

        <div class="footer-actions">
          <button class="secondary" data-reset="jamban">üîÑ Reset</button>
          <button class="secondary" data-save="jamban">üíæ Simpan Draft</button>
          <button data-submit="jamban" style="background: var(--ok); border-color: var(--ok);">‚úì Simpan ke Database</button>
        </div>
      </div>

      <!-- TAB: RTLH -->
      <div class="tabpanel" id="tab-rtlh" role="tabpanel">
        <div class="section-title">
          <div>
            <h2>RTLH</h2>
            <p>Nilai: 0‚Äì4. Terverifikasi jika 4 (4 pertanyaan wajib terisi).</p>
          </div>
          <div class="kpi">
            <span class="pill">Nilai: <strong id="score-rtlh">0</strong> / 4</span>
            <span class="badge warn" id="status-rtlh">‚ö† Belum Terverifikasi</span>
          </div>
        </div>

        <div class="q-list">
          <div class="q-item">
            <label>b3r301a ‚Äî Status kepemilikan bangunan tempat tinggal yang ditempati</label>
            <select data-module="rtlh" data-required="1" id="r_b3r301a">
              <option value="">‚Äî Pilih ‚Äî</option>
              <option value="1">1. Milik sendiri</option>
              <option value="2">2. Kontrak / Sewa</option>
              <option value="3">3. Bebas sewa</option>
              <option value="4">4. Dinas</option>
              <option value="5">5. Lainnya</option>
            </select>
          </div>

          <div class="q-item">
            <label>b3r303 ‚Äî Jenis lantai terluas</label>
            <select data-module="rtlh" data-required="1" id="r_b3r303">
              <option value="">‚Äî Pilih ‚Äî</option>
              <option value="1">1. Marmer / granit</option>
              <option value="2">2. Keramik</option>
              <option value="3">3. Parket / vinil / karpet</option>
              <option value="4">4. Ubin / tegel / teraso</option>
              <option value="5">5. Kayu / papan</option>
              <option value="6">6. Semen / bata merah</option>
              <option value="7">7. Bambu</option>
              <option value="8">8. Tanah</option>
              <option value="9">9. Lainnya</option>
            </select>
          </div>

          <div class="q-item">
            <label>b3r304 ‚Äî Jenis dinding terluas</label>
            <select data-module="rtlh" data-required="1" id="r_b3r304">
              <option value="">‚Äî Pilih ‚Äî</option>
              <option value="1">1. Tembok</option>
              <option value="2">2. Plesteran anyaman bambu kawat</option>
              <option value="3">3. Kayu / papan / gypsum / GRC / calciboard</option>
              <option value="4">4. Anyaman bambu</option>
              <option value="5">5. Batang kayu</option>
              <option value="6">6. Bambu</option>
              <option value="7">7. Lainnya</option>
            </select>
          </div>

          <div class="q-item">
            <label>b3r305 ‚Äî Jenis atap terluas</label>
            <select data-module="rtlh" data-required="1" id="r_b3r305">
              <option value="">‚Äî Pilih ‚Äî</option>
              <option value="1">1. Beton</option>
              <option value="2">2. Genteng</option>
              <option value="3">3. Seng</option>
              <option value="4">4. Asbes</option>
              <option value="5">5. Bumbu</option>
              <option value="6">6. Kayu / sirap</option>
              <option value="7">7. Jerami / ijuk / daun-daunan / rumbia</option>
              <option value="8">8. Lainnya</option>
            </select>
          </div>
        </div>

        <div class="footer-actions">
          <button class="secondary" data-reset="rtlh">üîÑ Reset</button>
          <button class="secondary" data-save="rtlh">üíæ Simpan Draft</button>
          <button data-submit="rtlh" style="background: var(--ok); border-color: var(--ok);">‚úì Simpan ke Database</button>
        </div>
      </div>

      <!-- TAB: PAH -->
      <div class="tabpanel" id="tab-pah" role="tabpanel">
        <div class="section-title">
          <div>
            <h2>PAH (Air Minum)</h2>
            <p>Nilai: 0‚Äì2. Terverifikasi jika 2 (2 pertanyaan wajib terisi).</p>
          </div>
          <div class="kpi">
            <span class="pill">Nilai: <strong id="score-pah">0</strong> / 2</span>
            <span class="badge warn" id="status-pah">‚ö† Belum Terverifikasi</span>
          </div>
        </div>

        <div class="q-list">
          <div class="q-item">
            <label>b3r301a ‚Äî Status kepemilikan bangunan tempat tinggal yang ditempati</label>
            <select data-module="pah" data-required="1" id="p_b3r301a">
              <option value="">‚Äî Pilih ‚Äî</option>
              <option value="1">1. Milik sendiri</option>
              <option value="2">2. Kontrak / Sewa</option>
              <option value="3">3. Bebas sewa</option>
              <option value="4">4. Dinas</option>
              <option value="5">5. Lainnya</option>
            </select>
          </div>

          <div class="q-item">
            <label>b3r306a ‚Äî Sumber air minum utama</label>
            <select data-module="pah" data-required="1" id="p_b3r306a">
              <option value="">‚Äî Pilih ‚Äî</option>
              <option value="1">1. Air kemasan bermerk</option>
              <option value="2">2. Air isi ulang</option>
              <option value="3">3. Leding</option>
              <option value="4">4. Sumur bor / pompa</option>
              <option value="5">5. Sumur terlindung</option>
              <option value="6">6. Sumur tak terlindung</option>
              <option value="7">7. Mata air terlindung</option>
              <option value="8">8. Mata air tak terlindung</option>
              <option value="9">9. Air permukaan (sungai / danau / waduk / kolam / irigasi)</option>
              <option value="10">10. Air hujan</option>
              <option value="11">11. Lainnya</option>
            </select>
          </div>
        </div>

        <div class="footer-actions">
          <button class="secondary" data-reset="pah">üîÑ Reset</button>
          <button class="secondary" data-save="pah">üíæ Simpan Draft</button>
          <button data-submit="pah" style="background: var(--ok); border-color: var(--ok);">‚úì Simpan ke Database</button>
        </div>
      </div>

    </div>
  </div>

  <script>
    const warga = [
      { nik:"3173010101010001", nama:"Siti Aminah", dusun:"Dusun I", rw:"02", rt:"01" },
      { nik:"3173010101010002", nama:"Budi Santoso", dusun:"Dusun I", rw:"02", rt:"02" },
      { nik:"3173010101010003", nama:"Rina Kurnia", dusun:"Dusun II", rw:"03", rt:"01" },
      { nik:"3173010101010004", nama:"Ahmad Fauzi", dusun:"Dusun III", rw:"01", rt:"03" },
      { nik:"3173010101010005", nama:"Dewi Lestari", dusun:"Dusun II", rw:"03", rt:"02" },
    ];
    const $ = (id) => document.getElementById(id);
    let selectedWarga = null;

    function setHeaderMode(mode){
      const header = $("headerBox");
      header.classList.toggle("compact", mode === "compact");
    }

    function scrollFormIntoView(){
      const form = $("formCard");
      const header = $("headerBox");
      const govHeader = document.querySelector('.gov-header');
      const headerH = header ? header.offsetHeight : 0;
      const govH = govHeader ? govHeader.offsetHeight : 0;
      const formTop = form.getBoundingClientRect().top + window.pageYOffset;
      const target = Math.max(0, formTop - headerH - govH - 24);
      window.scrollTo({ top: target, behavior: "smooth" });
    }

    // Tabs + dropdown selector
    const tabs = Array.from(document.querySelectorAll(".tab"));
    const panels = { jamban: $("tab-jamban"), rtlh: $("tab-rtlh"), pah: $("tab-pah") };
    function setActiveTab(key){
      tabs.forEach(t => {
        const active = t.dataset.tab === key;
        t.classList.toggle("active", active);
        t.setAttribute("aria-selected", active ? "true" : "false");
      });
      Object.entries(panels).forEach(([k, el]) => el.classList.toggle("active", k === key));
    }
    tabs.forEach(t => t.addEventListener("click", () => setActiveTab(t.dataset.tab)));

    // Scoring
    const rules = {
      jamban: { minVerified: 4, scoreEl: "score-jamban", statusEl: "status-jamban" },
      rtlh:   { minVerified: 4, scoreEl: "score-rtlh",   statusEl: "status-rtlh"   },
      pah:    { minVerified: 2, scoreEl: "score-pah",    statusEl: "status-pah"    },
    };
    function computeScore(module){
      const selects = Array.from(document.querySelectorAll(`select[data-module="${module}"][data-required="1"]`));
      let score = 0;
      selects.forEach(s => { if ((s.value || "").trim() !== "") score += 1; });

      const { minVerified, scoreEl, statusEl } = rules[module];
      $(scoreEl).textContent = score;

      const badge = $(statusEl);
      if (score >= minVerified){
        badge.textContent = "‚úì Sudah Terverifikasi";
        badge.classList.remove("warn");
        badge.classList.add("ok");
      } else {
        badge.textContent = "‚ö† Belum Terverifikasi";
        badge.classList.remove("ok");
        badge.classList.add("warn");
      }
      return score;
    }
    function computeAll(){ ["jamban","rtlh","pah"].forEach(computeScore); }
    document.querySelectorAll('select[data-module]').forEach(s => {
      s.addEventListener("change", () => {
        computeScore(s.dataset.module);
        autoSaveMinimal();
      });
    });

    // Search warga
    function normalize(v){ return (v || "").toString().trim().toLowerCase(); }

    function searchWarga(){
      const qText = normalize($("qText").value);
      const qDusun = normalize($("qDusun").value);
      const qRw = normalize($("qRw").value);
      const qRt = normalize($("qRt").value);

      const results = warga.filter(w => {
        const okText = !qText || normalize(w.nik).includes(qText) || normalize(w.nama).includes(qText);
        const okDusun = !qDusun || normalize(w.dusun).includes(qDusun);
        const okRw = !qRw || normalize(w.rw) === qRw;
        const okRt = !qRt || normalize(w.rt) === qRt;
        return okText && okDusun && okRw && okRt;
      });

      setHeaderMode("expanded");
      renderResults(results);
    }

    function renderResults(list){
      $("resList").innerHTML = "";
      $("resCount").textContent = list.length;

      if (list.length === 0){
        const div = document.createElement("div");
        div.className = "pill";
        div.textContent = "Tidak ada hasil. Ubah filter pencarian.";
        $("resList").appendChild(div);
        return;
      }

      list.forEach(w => {
        const item = document.createElement("div");
        item.className = "resitem";
        item.innerHTML = `
          <div class="name">${w.nama}</div>
          <div class="meta">
            <span>NIK: ${w.nik}</span>
            <span>${w.dusun}</span>
            <span>RW ${w.rw} / RT ${w.rt}</span>
          </div>
        `;
        item.addEventListener("click", () => selectWarga(w));
        $("resList").appendChild(item);
      });
    }

    function selectWarga(w){
      selectedWarga = w;

      // update expanded header labels
      $("selectedName").textContent = w.nama;
      $("selectedNik").textContent = w.nik;
      $("selectedArea").textContent = `${w.dusun} ‚Ä¢ RW ${w.rw} / RT ${w.rt}`;

      // update compact bar labels
      $("cName").textContent = w.nama;
      $("cNik").textContent = w.nik;
      $("cArea").textContent = `${w.dusun} ‚Ä¢ RW ${w.rw} / RT ${w.rt}`;

      loadDraftForSelected();

      // IMPORTANT: compact header + scroll so header doesn't cover form
      setHeaderMode("compact");
      setTimeout(scrollFormIntoView, 60);
    }

    $("btnSearch").addEventListener("click", searchWarga);

    // Enter key support untuk search
    $("qText").addEventListener("keypress", (e) => {
      if (e.key === "Enter") searchWarga();
    });

    $("btnClear").addEventListener("click", () => {
      $("qText").value = "";
      $("qDusun").value = "";
      $("qRw").value = "";
      $("qRt").value = "";
      $("resList").innerHTML = "";
      $("resCount").textContent = "0";
      selectedWarga = null;
      $("selectedName").textContent = "-";
      $("selectedNik").textContent = "-";
      $("selectedArea").textContent = "-";
    });

    // Change warga (back to expanded search)
    $("btnChangeWarga").addEventListener("click", () => {
      setHeaderMode("expanded");
      // optional: focus cursor to search
      setTimeout(() => $("qText").focus(), 50);
      // scroll to top so search is visible
      $("headerBox").scrollIntoView({ behavior:"smooth", block:"start" });
    });

    // Draft per warga + module
    function storageKey(module){
      const nik = selectedWarga?.nik || "anon";
      return `sidlite:${nik}:${module}`;
    }

    function collectModuleData(module){
      const selects = Array.from(document.querySelectorAll(`select[data-module="${module}"]`));
      const data = {};
      selects.forEach(s => data[s.id] = s.value);
      data._meta = {
        module,
        nik: selectedWarga?.nik || null,
        savedAt: new Date().toISOString(),
        score: computeScore(module),
      };
      return data;
    }

    function applyModuleData(module, data){
      if (!data) return;
      Object.keys(data).forEach(k => {
        const el = document.getElementById(k);
        if (el && el.tagName === "SELECT") el.value = data[k];
      });
      computeScore(module);
    }

    function loadDraft(module){
      const raw = localStorage.getItem(storageKey(module));
      if (!raw) return;
      try{ applyModuleData(module, JSON.parse(raw)); }catch(e){}
    }
    function loadDraftForSelected(){ ["jamban","rtlh","pah"].forEach(loadDraft); }

    function saveDraft(module){
      const payload = collectModuleData(module);
      localStorage.setItem(storageKey(module), JSON.stringify(payload));
      alert(`Draft tersimpan (module: ${module}).`);
    }

    function resetModule(module){
      document.querySelectorAll(`select[data-module="${module}"]`).forEach(s => s.value = "");
      computeScore(module);
      autoSaveMinimal();
    }

    document.querySelectorAll("button[data-save]").forEach(b => {
      b.addEventListener("click", () => {
        if (!selectedWarga){ alert("Pilih warga terlebih dahulu (pencarian)."); return; }
        saveDraft(b.dataset.save);
      });
    });

    document.querySelectorAll("button[data-reset]").forEach(b => {
      b.addEventListener("click", () => resetModule(b.dataset.reset));
    });

    // Submit to database
    async function submitToDatabase(module){
      if (!selectedWarga){
        alert("‚ùå Pilih warga terlebih dahulu menggunakan pencarian.");
        return;
      }

      const score = computeScore(module);
      const { minVerified } = rules[module];

      if (score < minVerified){
        const confirm = window.confirm(
          `‚ö†Ô∏è Peringatan:\n\n` +
          `Modul "${module.toUpperCase()}" belum terverifikasi lengkap.\n` +
          `Nilai saat ini: ${score}/${minVerified}\n\n` +
          `Apakah Anda yakin ingin menyimpan data yang belum lengkap ke database?`
        );
        if (!confirm) return;
      }

      const payload = collectModuleData(module);

      // TODO: Ganti dengan API call yang sebenarnya
      console.log("üì§ Mengirim data ke database:", payload);

      // Simulasi API call
      try {
        // await fetch('/api/save', { method: 'POST', body: JSON.stringify(payload) });

        // Simulasi success
        await new Promise(resolve => setTimeout(resolve, 500));

        alert(
          `‚úÖ Berhasil!\n\n` +
          `Data modul "${module.toUpperCase()}" untuk warga:\n` +
          `${selectedWarga.nama} (NIK: ${selectedWarga.nik})\n\n` +
          `telah berhasil disimpan ke database.`
        );

        // Auto save to localStorage as backup
        localStorage.setItem(storageKey(module), JSON.stringify(payload));

      } catch (error) {
        alert(`‚ùå Gagal menyimpan data:\n${error.message}`);
      }
    }

    document.querySelectorAll("button[data-submit]").forEach(b => {
      b.addEventListener("click", () => submitToDatabase(b.dataset.submit));
    });

    let autosaveTimer = null;
    function autoSaveMinimal(){
      if (!selectedWarga) return;
      clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => {
        ["jamban","rtlh","pah"].forEach(m => {
          localStorage.setItem(storageKey(m), JSON.stringify(collectModuleData(m)));
        });
      }, 250);
    }

    // Init
    computeAll();
    renderResults([]);
    setHeaderMode("expanded");
  </script>
</body>
</html>
