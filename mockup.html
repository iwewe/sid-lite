<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SID Lite – Form Pendataan Warga</title>
  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --text:#1f2a44;
      --muted:#5d6b86;
      --line:#d9e2f2;
      --accent:#1a73e8;
      --accentSoft:#e8f0fe;
      --ok:#0f9d58;
      --warn:#f29900;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px;}

    /* HEADER (sticky) */
    .header{
      background: var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      box-shadow: 0 8px 22px rgba(16,24,40,.06);
      position: sticky;
      top: 12px;
      z-index: 20;
      transition: padding .18s ease;
    }
    .header.compact{ padding:12px; }

    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;}
    .col{flex:1; min-width: 180px;}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px;}
    input, select, button{
      width:100%;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
    }
    input::placeholder{color:#93a3bf;}
    button{
      cursor:pointer;
      background: var(--accent);
      color:#fff;
      border:1px solid var(--accent);
      font-weight:800;
    }
    button.secondary{
      background:#fff;
      color: var(--text);
      border:1px solid var(--line);
      font-weight:800;
    }

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      font-size:12px; border:1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    .pill strong{color:var(--text); font-weight:900;}

    /* SEARCH AREA */
    .searchArea{ margin-top:12px; }
    .results{
      margin-top:12px;
      border:1px solid rgba(26,115,232,.25);
      border-radius:12px;
      padding:12px;
      background: var(--accentSoft);
    }
    .results-top{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .results-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .reslist{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 240px;
      overflow:auto;
      padding-right:4px;
    }
    .resitem{
      text-align:left;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
    }
    .resitem:hover{border-color: rgba(26,115,232,.35);}
    .resitem .name{font-weight:900;}
    .resitem .meta{font-size:12px; color: var(--muted); margin-top:3px; display:flex; gap:10px; flex-wrap:wrap;}

    /* COMPACT BAR (shown when selected) */
    .compactBar{
      display:none;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .header.compact .compactBar{ display:flex; }
    .header.compact .searchArea{ display:none; }  /* hide search in compact mode */

    .compactLeft{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .compactRight{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .compactTitle{
      font-weight:900;
      color: var(--text);
      font-size:13px;
      margin-right:2px;
    }

    /* MAIN CARD */
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      box-shadow: 0 8px 22px rgba(16,24,40,.06);
      margin-top:14px;
    }
    .section-title{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .section-title h2{margin:0; font-size:16px;}
    .section-title p{margin:4px 0 0; color:var(--muted); font-size:12px; line-height:1.4;}
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      border-bottom:1px solid var(--line);
      padding-bottom:10px;
      margin-bottom:14px;
    }
    .tab{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      font-weight:900;
    }
    .tab.active{
      color: var(--accent);
      border-color: rgba(26,115,232,.45);
      background: var(--accentSoft);
    }
    .tabpanel{display:none;}
    .tabpanel.active{display:block;}

    .kpi{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; font-size:12px;
      border:1px solid var(--line);
      background: #fff;
      font-weight:900;
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(15,157,88,.35); background: rgba(15,157,88,.10); color: var(--ok);}
    .badge.warn{border-color: rgba(242,153,0,.35); background: rgba(242,153,0,.10); color: var(--warn);}

    .q-list{display:flex; flex-direction:column; gap:12px;}
    .q-item{
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      background:#fff;
    }
    .q-item label{
      margin:0 0 8px;
      font-size:13px;
      color: var(--text);
      font-weight:900;
    }

    .footer-actions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      margin-top:14px;
    }
    .mini{font-size:12px; color: var(--muted); margin-top:6px;}

    @media (max-width: 860px){
      .header{position: static;}
      .reslist{max-height: 320px;}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- HEADER -->
    <div class="header" id="headerBox">

      <!-- COMPACT MODE BAR -->
      <div class="compactBar">
        <div class="compactLeft">
          <span class="compactTitle">Warga Terpilih</span>
          <span class="pill"><strong id="cName">-</strong></span>
          <span class="pill">NIK: <strong id="cNik">-</strong></span>
          <span class="pill">Wilayah: <strong id="cArea">-</strong></span>
        </div>
        <div class="compactRight">
          <button id="btnChangeWarga" class="secondary" style="min-width:160px">Ganti Warga</button>
          <button id="btnExportCompact" class="secondary" style="min-width:160px">Export JSON</button>
        </div>
      </div>

      <!-- EXPANDED SEARCH AREA -->
      <div class="searchArea" id="searchArea">
        <div class="row">
          <div class="col" style="min-width:220px">
            <label>Pencarian (NIK / Nama)</label>
            <input id="qText" type="text" placeholder="Contoh: 3173... atau 'Siti'" />
          </div>
          <div class="col">
            <label>Dusun</label>
            <input id="qDusun" type="text" placeholder="Contoh: Dusun I" />
          </div>
          <div class="col">
            <label>RW</label>
            <input id="qRw" type="text" placeholder="Contoh: 02" />
          </div>
          <div class="col">
            <label>RT</label>
            <input id="qRt" type="text" placeholder="Contoh: 01" />
          </div>
          <div class="col" style="min-width:160px">
            <label>&nbsp;</label>
            <button id="btnSearch">Cari Warga</button>
            <div class="mini">Dummy data (silakan ganti dari API).</div>
          </div>
        </div>

        <div class="results" id="resultsBox">
          <div class="results-top">
            <div class="results-actions">
              <span class="pill">Hasil: <strong id="resCount">0</strong></span>
              <span class="pill">Warga Terpilih: <strong id="selectedName">-</strong></span>
              <span class="pill">NIK: <strong id="selectedNik">-</strong></span>
              <span class="pill">Wilayah: <strong id="selectedArea">-</strong></span>
            </div>
            <div class="results-actions">
              <button id="btnClear" class="secondary" style="min-width:160px">Reset Filter</button>
              <button id="btnExport" class="secondary" style="min-width:160px">Export JSON</button>
            </div>
          </div>
          <div class="reslist" id="resList"></div>
        </div>
      </div>
    </div>

    <!-- MAIN FORM -->
    <div class="card" id="formCard">
      <div class="section-title">
        <div>
          <h2>SID Lite – Verifikasi Sarana Prasarana Rumah Tinggal</h2>
          <p>Isi data pada tab. Status verifikasi dihitung dari jumlah pertanyaan wajib yang sudah dipilih.</p>
        </div>
        <div style="min-width:240px">
          <label>Pilih Modul (Dropdown – alternatif tab)</label>
          <select id="tabSelect">
            <option value="jamban">Jamban Septic</option>
            <option value="rtlh">RTLH</option>
            <option value="pah">PAH (Air Minum)</option>
          </select>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Tabs">
        <div class="tab active" data-tab="jamban" role="tab" aria-selected="true">Jamban Septic</div>
        <div class="tab" data-tab="rtlh" role="tab" aria-selected="false">RTLH</div>
        <div class="tab" data-tab="pah" role="tab" aria-selected="false">PAH</div>
      </div>

      <!-- TAB: JAMBAN -->
      <div class="tabpanel active" id="tab-jamban" role="tabpanel">
        <div class="section-title">
          <div>
            <h2>Jamban Septic</h2>
            <p>Nilai: 0–4. Terverifikasi jika 4 (4 pertanyaan wajib terisi).</p>
          </div>
          <div class="kpi">
            <span class="pill">Nilai: <strong id="score-jamban">0</strong> / 4</span>
            <span class="badge warn" id="status-jamban">Belum Terverifikasi</span>
          </div>
        </div>

        <div class="q-list">
          <div class="q-item">
            <label>b3r301a — Status kepemilikan bangunan tempat tinggal yang ditempati</label>
            <select data-module="jamban" data-required="1" id="j_b3r301a">
              <option value="">— Pilih —</option>
              <option value="1">1. Milik sendiri</option>
              <option value="2">2. Kontrak / Sewa</option>
              <option value="3">3. Bebas sewa</option>
              <option value="4">4. Dinas</option>
              <option value="5">5. Lainnya</option>
            </select>
          </div>

          <div class="q-item">
            <label>b3r309a — Kepemilikan dan penggunaan fasilitas tempat buang air besar</label>
            <select data-module="jamban" data-required="1" id="j_b3r309a">
              <option value="">— Pilih —</option>
              <option value="1">1. Ada, digunakan hanya anggota keluarga sendiri</option>
              <option value="2">2. Ada, digunakan bersama anggota keluarga dari keluarga tertentu</option>
              <option value="3">3. Ada, di MCK komunal</option>
              <option value="4">4. Ada, di MCK umum / siapapun menggunakan</option>
              <option value="5">5. Ada, anggota keluarga tidak menggunakan</option>
              <option value="6">6. Tidak ada fasilitas</option>
            </select>
          </div>

          <div class="q-item">
            <label>b3r309b — Jenis kloset</label>
            <select data-module="jamban" data-required="1" id="j_b3r309b">
              <option value="">— Pilih —</option>
              <option value="1">1. Kloset duduk leher angsa</option>
              <option value="2">2. Kloset jongkok leher angsa</option>
              <option value="3">3. Plengsengan dengan tutup</option>
              <option value="4">4. Plengsengan tanpa tutup</option>
              <option value="5">5. Cemplung / cubluk</option>
            </select>
          </div>

          <div class="q-item">
            <label>b3r310 — Tempat pembuangan akhir tinja</label>
            <select data-module="jamban" data-required="1" id="j_b3r310">
              <option value="">— Pilih —</option>
              <option value="1">1. Tangki septik</option>
              <option value="2">2. IPAL</option>
              <option value="3">3. Kolam / sawah / sungai / danau / laut</option>
              <option value="4">4. Lubang tanah</option>
              <option value="5">5. Pantai / tanah lapang / kebun</option>
              <option value="6">6. Lainnya</option>
            </select>
          </div>
        </div>

        <div class="footer-actions">
          <button class="secondary" data-reset="jamban">Reset Tab</button>
          <button data-save="jamban">Simpan Draft (LocalStorage)</button>
        </div>
      </div>

      <!-- TAB: RTLH -->
      <div class="tabpanel" id="tab-rtlh" role="tabpanel">
        <div class="section-title">
          <div>
            <h2>RTLH</h2>
            <p>Nilai: 0–4. Terverifikasi jika 4 (4 pertanyaan wajib terisi).</p>
          </div>
          <div class="kpi">
            <span class="pill">Nilai: <strong id="score-rtlh">0</strong> / 4</span>
            <span class="badge warn" id="status-rtlh">Belum Terverifikasi</span>
          </div>
        </div>

        <div class="q-list">
          <div class="q-item">
            <label>b3r301a — Status kepemilikan bangunan tempat tinggal yang ditempati</label>
            <select data-module="rtlh" data-required="1" id="r_b3r301a">
              <option value="">— Pilih —</option>
              <option value="1">1. Milik sendiri</option>
              <option value="2">2. Kontrak / Sewa</option>
              <option value="3">3. Bebas sewa</option>
              <option value="4">4. Dinas</option>
              <option value="5">5. Lainnya</option>
            </select>
          </div>

          <div class="q-item">
            <label>b3r303 — Jenis lantai terluas</label>
            <select data-module="rtlh" data-required="1" id="r_b3r303">
              <option value="">— Pilih —</option>
              <option value="1">1. Marmer / granit</option>
              <option value="2">2. Keramik</option>
              <option value="3">3. Parket / vinil / karpet</option>
              <option value="4">4. Ubin / tegel / teraso</option>
              <option value="5">5. Kayu / papan</option>
              <option value="6">6. Semen / bata merah</option>
              <option value="7">7. Bambu</option>
              <option value="8">8. Tanah</option>
              <option value="9">9. Lainnya</option>
            </select>
          </div>

          <div class="q-item">
            <label>b3r304 — Jenis dinding terluas</label>
            <select data-module="rtlh" data-required="1" id="r_b3r304">
              <option value="">— Pilih —</option>
              <option value="1">1. Tembok</option>
              <option value="2">2. Plesteran anyaman bambu kawat</option>
              <option value="3">3. Kayu / papan / gypsum / GRC / calciboard</option>
              <option value="4">4. Anyaman bambu</option>
              <option value="5">5. Batang kayu</option>
              <option value="6">6. Bambu</option>
              <option value="7">7. Lainnya</option>
            </select>
          </div>

          <div class="q-item">
            <label>b3r305 — Jenis atap terluas</label>
            <select data-module="rtlh" data-required="1" id="r_b3r305">
              <option value="">— Pilih —</option>
              <option value="1">1. Beton</option>
              <option value="2">2. Genteng</option>
              <option value="3">3. Seng</option>
              <option value="4">4. Asbes</option>
              <option value="5">5. Bumbu</option>
              <option value="6">6. Kayu / sirap</option>
              <option value="7">7. Jerami / ijuk / daun-daunan / rumbia</option>
              <option value="8">8. Lainnya</option>
            </select>
          </div>
        </div>

        <div class="footer-actions">
          <button class="secondary" data-reset="rtlh">Reset Tab</button>
          <button data-save="rtlh">Simpan Draft (LocalStorage)</button>
        </div>
      </div>

      <!-- TAB: PAH -->
      <div class="tabpanel" id="tab-pah" role="tabpanel">
        <div class="section-title">
          <div>
            <h2>PAH (Air Minum)</h2>
            <p>Nilai: 0–2. Terverifikasi jika 2 (2 pertanyaan wajib terisi).</p>
          </div>
          <div class="kpi">
            <span class="pill">Nilai: <strong id="score-pah">0</strong> / 2</span>
            <span class="badge warn" id="status-pah">Belum Terverifikasi</span>
          </div>
        </div>

        <div class="q-list">
          <div class="q-item">
            <label>b3r301a — Status kepemilikan bangunan tempat tinggal yang ditempati</label>
            <select data-module="pah" data-required="1" id="p_b3r301a">
              <option value="">— Pilih —</option>
              <option value="1">1. Milik sendiri</option>
              <option value="2">2. Kontrak / Sewa</option>
              <option value="3">3. Bebas sewa</option>
              <option value="4">4. Dinas</option>
              <option value="5">5. Lainnya</option>
            </select>
          </div>

          <div class="q-item">
            <label>b3r306a — Sumber air minum utama</label>
            <select data-module="pah" data-required="1" id="p_b3r306a">
              <option value="">— Pilih —</option>
              <option value="1">1. Air kemasan bermerk</option>
              <option value="2">2. Air isi ulang</option>
              <option value="3">3. Leding</option>
              <option value="4">4. Sumur bor / pompa</option>
              <option value="5">5. Sumur terlindung</option>
              <option value="6">6. Sumur tak terlindung</option>
              <option value="7">7. Mata air terlindung</option>
              <option value="8">8. Mata air tak terlindung</option>
              <option value="9">9. Air permukaan (sungai / danau / waduk / kolam / irigasi)</option>
              <option value="10">10. Air hujan</option>
              <option value="11">11. Lainnya</option>
            </select>
          </div>
        </div>

        <div class="footer-actions">
          <button class="secondary" data-reset="pah">Reset Tab</button>
          <button data-save="pah">Simpan Draft (LocalStorage)</button>
        </div>
      </div>

    </div>
  </div>

  <script>
    const warga = [
      { nik:"3173010101010001", nama:"Siti Aminah", dusun:"Dusun I", rw:"02", rt:"01" },
      { nik:"3173010101010002", nama:"Budi Santoso", dusun:"Dusun I", rw:"02", rt:"02" },
      { nik:"3173010101010003", nama:"Rina Kurnia", dusun:"Dusun II", rw:"03", rt:"01" },
      { nik:"3173010101010004", nama:"Ahmad Fauzi", dusun:"Dusun III", rw:"01", rt:"03" },
      { nik:"3173010101010005", nama:"Dewi Lestari", dusun:"Dusun II", rw:"03", rt:"02" },
    ];
    const $ = (id) => document.getElementById(id);
    let selectedWarga = null;

    function setHeaderMode(mode){
      const header = $("headerBox");
      header.classList.toggle("compact", mode === "compact");
    }

    function scrollFormIntoView(){
      const form = $("formCard");
      const header = $("headerBox");
      const headerH = header ? header.offsetHeight : 0;
      const formTop = form.getBoundingClientRect().top + window.pageYOffset;
      const target = Math.max(0, formTop - headerH - 16);
      window.scrollTo({ top: target, behavior: "smooth" });
    }

    // Tabs + dropdown selector
    const tabs = Array.from(document.querySelectorAll(".tab"));
    const panels = { jamban: $("tab-jamban"), rtlh: $("tab-rtlh"), pah: $("tab-pah") };
    function setActiveTab(key){
      tabs.forEach(t => {
        const active = t.dataset.tab === key;
        t.classList.toggle("active", active);
        t.setAttribute("aria-selected", active ? "true" : "false");
      });
      Object.entries(panels).forEach(([k, el]) => el.classList.toggle("active", k === key));
      $("tabSelect").value = key;
    }
    tabs.forEach(t => t.addEventListener("click", () => setActiveTab(t.dataset.tab)));
    $("tabSelect").addEventListener("change", (e) => setActiveTab(e.target.value));

    // Scoring
    const rules = {
      jamban: { minVerified: 4, scoreEl: "score-jamban", statusEl: "status-jamban" },
      rtlh:   { minVerified: 4, scoreEl: "score-rtlh",   statusEl: "status-rtlh"   },
      pah:    { minVerified: 2, scoreEl: "score-pah",    statusEl: "status-pah"    },
    };
    function computeScore(module){
      const selects = Array.from(document.querySelectorAll(`select[data-module="${module}"][data-required="1"]`));
      let score = 0;
      selects.forEach(s => { if ((s.value || "").trim() !== "") score += 1; });

      const { minVerified, scoreEl, statusEl } = rules[module];
      $(scoreEl).textContent = score;

      const badge = $(statusEl);
      if (score >= minVerified){
        badge.textContent = "Sudah Terverifikasi";
        badge.classList.remove("warn");
        badge.classList.add("ok");
      } else {
        badge.textContent = "Belum Terverifikasi";
        badge.classList.remove("ok");
        badge.classList.add("warn");
      }
      return score;
    }
    function computeAll(){ ["jamban","rtlh","pah"].forEach(computeScore); }
    document.querySelectorAll('select[data-module]').forEach(s => {
      s.addEventListener("change", () => {
        computeScore(s.dataset.module);
        autoSaveMinimal();
      });
    });

    // Search warga
    function normalize(v){ return (v || "").toString().trim().toLowerCase(); }

    function searchWarga(){
      const qText = normalize($("qText").value);
      const qDusun = normalize($("qDusun").value);
      const qRw = normalize($("qRw").value);
      const qRt = normalize($("qRt").value);

      const results = warga.filter(w => {
        const okText = !qText || normalize(w.nik).includes(qText) || normalize(w.nama).includes(qText);
        const okDusun = !qDusun || normalize(w.dusun).includes(qDusun);
        const okRw = !qRw || normalize(w.rw) === qRw;
        const okRt = !qRt || normalize(w.rt) === qRt;
        return okText && okDusun && okRw && okRt;
      });

      setHeaderMode("expanded");
      renderResults(results);
    }

    function renderResults(list){
      $("resList").innerHTML = "";
      $("resCount").textContent = list.length;

      if (list.length === 0){
        const div = document.createElement("div");
        div.className = "pill";
        div.textContent = "Tidak ada hasil. Ubah filter pencarian.";
        $("resList").appendChild(div);
        return;
      }

      list.forEach(w => {
        const item = document.createElement("div");
        item.className = "resitem";
        item.innerHTML = `
          <div class="name">${w.nama}</div>
          <div class="meta">
            <span>NIK: ${w.nik}</span>
            <span>${w.dusun}</span>
            <span>RW ${w.rw} / RT ${w.rt}</span>
          </div>
        `;
        item.addEventListener("click", () => selectWarga(w));
        $("resList").appendChild(item);
      });
    }

    function selectWarga(w){
      selectedWarga = w;

      // update expanded header labels
      $("selectedName").textContent = w.nama;
      $("selectedNik").textContent = w.nik;
      $("selectedArea").textContent = `${w.dusun} • RW ${w.rw} / RT ${w.rt}`;

      // update compact bar labels
      $("cName").textContent = w.nama;
      $("cNik").textContent = w.nik;
      $("cArea").textContent = `${w.dusun} • RW ${w.rw} / RT ${w.rt}`;

      loadDraftForSelected();

      // IMPORTANT: compact header + scroll so header doesn't cover form
      setHeaderMode("compact");
      setTimeout(scrollFormIntoView, 60);
    }

    $("btnSearch").addEventListener("click", searchWarga);

    $("btnClear").addEventListener("click", () => {
      $("qText").value = "";
      $("qDusun").value = "";
      $("qRw").value = "";
      $("qRt").value = "";
      $("resList").innerHTML = "";
      $("resCount").textContent = "0";
      selectedWarga = null;
      $("selectedName").textContent = "-";
      $("selectedNik").textContent = "-";
      $("selectedArea").textContent = "-";
    });

    // Change warga (back to expanded search)
    $("btnChangeWarga").addEventListener("click", () => {
      setHeaderMode("expanded");
      // optional: focus cursor to search
      setTimeout(() => $("qText").focus(), 50);
      // scroll to top so search is visible
      $("headerBox").scrollIntoView({ behavior:"smooth", block:"start" });
    });

    // Draft per warga + module
    function storageKey(module){
      const nik = selectedWarga?.nik || "anon";
      return `sidlite:${nik}:${module}`;
    }

    function collectModuleData(module){
      const selects = Array.from(document.querySelectorAll(`select[data-module="${module}"]`));
      const data = {};
      selects.forEach(s => data[s.id] = s.value);
      data._meta = {
        module,
        nik: selectedWarga?.nik || null,
        savedAt: new Date().toISOString(),
        score: computeScore(module),
      };
      return data;
    }

    function applyModuleData(module, data){
      if (!data) return;
      Object.keys(data).forEach(k => {
        const el = document.getElementById(k);
        if (el && el.tagName === "SELECT") el.value = data[k];
      });
      computeScore(module);
    }

    function loadDraft(module){
      const raw = localStorage.getItem(storageKey(module));
      if (!raw) return;
      try{ applyModuleData(module, JSON.parse(raw)); }catch(e){}
    }
    function loadDraftForSelected(){ ["jamban","rtlh","pah"].forEach(loadDraft); }

    function saveDraft(module){
      const payload = collectModuleData(module);
      localStorage.setItem(storageKey(module), JSON.stringify(payload));
      alert(`Draft tersimpan (module: ${module}).`);
    }

    function resetModule(module){
      document.querySelectorAll(`select[data-module="${module}"]`).forEach(s => s.value = "");
      computeScore(module);
      autoSaveMinimal();
    }

    document.querySelectorAll("button[data-save]").forEach(b => {
      b.addEventListener("click", () => {
        if (!selectedWarga){ alert("Pilih warga terlebih dahulu (pencarian)."); return; }
        saveDraft(b.dataset.save);
      });
    });

    document.querySelectorAll("button[data-reset]").forEach(b => {
      b.addEventListener("click", () => resetModule(b.dataset.reset));
    });

    let autosaveTimer = null;
    function autoSaveMinimal(){
      if (!selectedWarga) return;
      clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => {
        ["jamban","rtlh","pah"].forEach(m => {
          localStorage.setItem(storageKey(m), JSON.stringify(collectModuleData(m)));
        });
      }, 250);
    }

    async function exportJson(){
      const exportObj = {
        warga: selectedWarga,
        jamban: collectModuleData("jamban"),
        rtlh: collectModuleData("rtlh"),
        pah: collectModuleData("pah"),
        exportedAt: new Date().toISOString(),
      };
      const text = JSON.stringify(exportObj, null, 2);
      try{
        await navigator.clipboard.writeText(text);
        alert("JSON berhasil disalin ke clipboard.");
      }catch(e){
        prompt("Copy JSON berikut:", text);
      }
    }
    $("btnExport").addEventListener("click", exportJson);
    $("btnExportCompact").addEventListener("click", exportJson);

    // Init
    computeAll();
    renderResults([]);
    setHeaderMode("expanded");
  </script>
</body>
</html>
